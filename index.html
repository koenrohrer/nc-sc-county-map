<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NC Sales Territory Map | Meridian Waste</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        :root {
            --mw-navy: #1a2a3a;
            --mw-navy-light: #2d4052;
            --mw-orange: #f7941d;
            --mw-orange-hover: #e8850a;
            --mw-gray-light: #f5f5f5;
            --mw-gray: #e0e0e0;
            --mw-gray-dark: #666;
            --mw-text: #333;
            --mw-white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--mw-gray-light);
            color: var(--mw-text);
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: var(--mw-white);
            border-right: 1px solid var(--mw-gray);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 24px 20px;
            background: var(--mw-navy);
            color: var(--mw-white);
            border-bottom: 4px solid var(--mw-orange);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--mw-gray);
        }

        .sidebar-section h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--mw-navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        /* Sales Rep Form */
        .add-rep-form {
            display: flex;
            gap: 8px;
        }

        .add-rep-form input[type="text"] {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .add-rep-form input[type="text"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .add-rep-form input[type="color"] {
            width: 44px;
            height: 42px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            padding: 3px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--mw-orange);
            color: var(--mw-white);
        }

        .btn-primary:hover {
            background: var(--mw-orange-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #c0392b;
            color: var(--mw-white);
        }

        .btn-danger:hover {
            background: #a93226;
        }

        .btn-secondary {
            background: var(--mw-navy);
            color: var(--mw-white);
        }

        .btn-secondary:hover {
            background: var(--mw-navy-light);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
        }

        /* Sales Rep List */
        .rep-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .rep-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: var(--mw-gray-light);
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid var(--mw-orange);
            transition: box-shadow 0.2s;
        }

        .rep-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rep-color {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            margin-right: 14px;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .rep-info {
            flex: 1;
        }

        .rep-name {
            font-weight: 600;
            color: var(--mw-navy);
        }

        .rep-counties {
            font-size: 12px;
            color: var(--mw-gray-dark);
            margin-top: 3px;
        }

        .rep-actions {
            display: flex;
            gap: 6px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: var(--mw-gray-light);
            padding: 16px;
            border-radius: 6px;
            text-align: center;
            border-top: 3px solid var(--mw-navy);
        }

        .stat-card.highlight {
            border-top-color: var(--mw-orange);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--mw-navy);
        }

        .stat-label {
            font-size: 11px;
            color: var(--mw-gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #e8eef3 0%, #d4dce4 100%);
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .county {
            stroke: var(--mw-white);
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .county:hover {
            opacity: 0.85;
            stroke: var(--mw-navy);
            stroke-width: 2px;
        }

        .county.unassigned {
            fill: #d0d8e0;
        }

        .county-label {
            font-size: 8px;
            fill: var(--mw-navy);
            pointer-events: none;
            text-anchor: middle;
            font-weight: 500;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--mw-navy);
            color: var(--mw-white);
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            max-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-left: 4px solid var(--mw-orange);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip-rep {
            color: var(--mw-orange);
        }

        /* Assignment Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 42, 58, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--mw-white);
            border-radius: 8px;
            padding: 0;
            min-width: 340px;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background: var(--mw-navy);
            color: var(--mw-white);
            padding: 18px 24px;
            border-bottom: 4px solid var(--mw-orange);
        }

        .modal h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
        }

        .modal select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .modal select:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Export Button */
        .export-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 50;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--mw-white);
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            max-width: 220px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 50;
            border-top: 4px solid var(--mw-orange);
        }

        .legend h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--mw-navy);
            margin-bottom: 14px;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
            color: var(--mw-text);
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--mw-white);
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mw-navy);
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--mw-orange);
            border-color: var(--mw-orange);
            color: var(--mw-white);
        }

        /* Scrollbar styling */
        .rep-list::-webkit-scrollbar,
        .legend::-webkit-scrollbar {
            width: 6px;
        }

        .rep-list::-webkit-scrollbar-track,
        .legend::-webkit-scrollbar-track {
            background: var(--mw-gray-light);
        }

        .rep-list::-webkit-scrollbar-thumb,
        .legend::-webkit-scrollbar-thumb {
            background: var(--mw-gray);
            border-radius: 3px;
        }

        .rep-list::-webkit-scrollbar-thumb:hover,
        .legend::-webkit-scrollbar-thumb:hover {
            background: var(--mw-gray-dark);
        }

        /* Split Mode Styles */
        .split-mode-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--mw-orange);
            color: var(--mw-white);
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .split-mode-banner.visible {
            display: flex;
        }

        .split-mode-banner .instructions {
            font-size: 14px;
        }

        .split-mode-banner .cancel-btn {
            background: var(--mw-white);
            color: var(--mw-orange);
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .split-mode-banner .cancel-btn:hover {
            background: var(--mw-gray-light);
        }

        .split-line-preview {
            stroke: var(--mw-orange);
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            pointer-events: none;
        }

        .split-point {
            fill: var(--mw-orange);
            stroke: var(--mw-white);
            stroke-width: 2;
            cursor: pointer;
        }

        .county.split-target {
            stroke: var(--mw-orange) !important;
            stroke-width: 3px !important;
            stroke-dasharray: 5, 3;
        }

        .split-county-half {
            stroke: var(--mw-white);
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .split-county-half:hover {
            opacity: 0.85;
            stroke: var(--mw-navy);
            stroke-width: 2px;
        }

        .split-divider {
            stroke: var(--mw-white);
            stroke-width: 2px;
            pointer-events: none;
        }

        /* Modal split section */
        .modal-split-section {
            border-top: 1px solid var(--mw-gray);
            margin-top: 16px;
            padding-top: 16px;
        }

        .modal-split-section p {
            font-size: 13px;
            color: var(--mw-gray-dark);
            margin-bottom: 12px;
        }

        .btn-split {
            background: var(--mw-orange);
            color: var(--mw-white);
            width: 100%;
        }

        .btn-split:hover {
            background: var(--mw-orange-hover);
        }

        /* Split assignment modal */
        .split-rep-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .split-rep-select label {
            font-size: 12px;
            font-weight: 600;
            color: var(--mw-navy);
            text-transform: uppercase;
            margin-bottom: 6px;
            display: block;
        }

        .split-rep-select select {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Sales Territory Map</h1>
                <div class="subtitle">North Carolina</div>
            </div>

            <!-- Add Sales Rep -->
            <div class="sidebar-section">
                <h2>Add Sales Rep</h2>
                <div class="add-rep-form">
                    <input type="text" id="repName" placeholder="Rep name...">
                    <input type="color" id="repColor" value="#f7941d">
                    <button class="btn btn-primary" onclick="addSalesRep()">Add</button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="sidebar-section">
                <h2>Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-value" id="totalReps">0</div>
                        <div class="stat-label">Sales Reps</div>
                    </div>
                    <div class="stat-card highlight">
                        <div class="stat-value" id="assignedCounties">0</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="unassignedCounties">100</div>
                        <div class="stat-label">Unassigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCounties">100</div>
                        <div class="stat-label">Total Counties</div>
                    </div>
                </div>
            </div>

            <!-- Sales Rep List -->
            <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <h2>Sales Reps</h2>
            </div>
            <div class="rep-list" id="repList">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div class="split-mode-banner" id="splitModeBanner">
                <span class="instructions">Click two points on the county boundary to draw a split line</span>
                <button class="cancel-btn" onclick="cancelSplitMode()">Cancel</button>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <button class="zoom-btn" onclick="resetZoom()">⟲</button>
            </div>
            <button class="btn btn-secondary export-btn" onclick="exportMap()">Export as Image</button>
            <div id="map"></div>
            <div class="tooltip" id="tooltip"></div>
            <div class="legend" id="legend">
                <h3>Legend</h3>
                <div id="legendItems"></div>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Assign County</h3>
            </div>
            <div class="modal-body">
                <select id="repSelect">
                    <option value="">-- Select Sales Rep --</option>
                </select>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="unassignCounty()">Unassign</button>
                    <button class="btn btn-primary" onclick="assignCounty()">Assign</button>
                </div>
                <div class="modal-split-section" id="splitSection" style="display: none;">
                    <p>This county is already assigned. Split it between two reps?</p>
                    <button class="btn btn-split" onclick="startSplitMode()">Split County</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Split Assignment Modal -->
    <div class="modal-overlay" id="splitModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="splitModalTitle">Assign Split Regions</h3>
            </div>
            <div class="modal-body">
                <div class="split-rep-select">
                    <div>
                        <label>Side 1 (highlighted)</label>
                        <select id="splitRep1">
                            <option value="">-- Select Rep --</option>
                        </select>
                    </div>
                    <div>
                        <label>Side 2</label>
                        <select id="splitRep2">
                            <option value="">-- Select Rep --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="cancelSplitAssignment()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmSplitAssignment()">Confirm Split</button>
                </div>
            </div>
        </div>
    </div>

    <script src="nc-counties.js"></script>
    <script>
        // State
        let salesReps = [];
        let assignments = {}; // countyId -> repId OR { split: true, line: [...], rep1: id, rep2: id }
        let selectedCounty = null;

        // Split Mode State
        let splitMode = false;
        let splitCountyId = null;
        let splitCountyFeature = null;
        let splitPoints = [];
        let splitLinePreview = null;
        let splitPolygons = null;

        // D3 Variables
        let svg, g, projection, path, zoom;
        const width = 900;
        const height = 600;

        // Security: HTML escaping to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Security: Validate hex color format
        function sanitizeColor(color) {
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                return color;
            }
            return '#f7941d';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            initMap();
            renderRepList();
            updateStats();
            updateLegend();
        });

        // Local Storage
        function saveToLocalStorage() {
            localStorage.setItem('nc-territory-reps', JSON.stringify(salesReps));
            localStorage.setItem('nc-territory-assignments', JSON.stringify(assignments));
        }

        function loadFromLocalStorage() {
            try {
                const reps = localStorage.getItem('nc-territory-reps');
                const assigns = localStorage.getItem('nc-territory-assignments');

                if (reps) {
                    const parsed = JSON.parse(reps);
                    if (Array.isArray(parsed)) {
                        salesReps = parsed.filter(r => r && r.id && r.name && r.color);
                    }
                }
                if (assigns) {
                    const parsed = JSON.parse(assigns);
                    if (typeof parsed === 'object' && parsed !== null) {
                        assignments = parsed;
                    }
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                salesReps = [];
                assignments = {};
            }
        }

        // Check if assignment is a split
        function isSplitAssignment(assignment) {
            return assignment && typeof assignment === 'object' && assignment.split === true;
        }

        // Map Initialization
        function initMap() {
            const container = document.getElementById('map');

            svg = d3.select('#map')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);

            // Create zoom behavior
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g');

            // Setup projection centered on NC
            projection = d3.geoMercator()
                .center([-79.5, 35.5])
                .scale(6000)
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Draw counties
            drawCounties();

            // Add click handler for split mode
            svg.on('click', handleSvgClick);
        }

        function drawCounties() {
            // Draw regular (non-split) counties
            ncCountiesGeoJSON.features.forEach(feature => {
                const countyId = feature.properties.GEOID;
                const assignment = assignments[countyId];

                if (isSplitAssignment(assignment)) {
                    drawSplitCounty(feature, assignment);
                } else {
                    drawRegularCounty(feature);
                }
            });

            // Add county labels
            g.selectAll('.county-label')
                .data(ncCountiesGeoJSON.features)
                .enter()
                .append('text')
                .attr('class', 'county-label')
                .attr('transform', d => `translate(${path.centroid(d)})`)
                .text(d => d.properties.NAME);
        }

        function drawRegularCounty(feature) {
            const countyId = feature.properties.GEOID;
            const assignment = assignments[countyId];

            g.append('path')
                .datum(feature)
                .attr('class', `county ${assignment ? '' : 'unassigned'}`)
                .attr('d', path)
                .attr('fill', getCountyColor(countyId))
                .attr('data-id', countyId)
                .on('click', (event, d) => {
                    if (!splitMode) {
                        openModal(d.properties);
                    }
                })
                .on('mouseover', (event, d) => showTooltip(event, d.properties))
                .on('mousemove', (event) => moveTooltip(event))
                .on('mouseout', hideTooltip);
        }

        function drawSplitCounty(feature, assignment) {
            const countyId = feature.properties.GEOID;
            const clipId = `clip-${countyId}`;

            try {
                // Create a clip path using the original county boundary (the master copy)
                // This ensures all fills stay strictly within the county borders
                let defs = svg.select('defs');
                if (defs.empty()) {
                    defs = svg.insert('defs', ':first-child');
                }

                // Remove any existing clip path for this county
                defs.select(`#${clipId}`).remove();

                // Create clip path from the original county boundary
                const clipPath = defs.append('clipPath')
                    .attr('id', clipId);

                clipPath.append('path')
                    .datum(feature)
                    .attr('d', path);

                // Get the line coordinates in screen space
                const lineCoords = assignment.line.map(coord => projection(coord));

                // Calculate the bounding box of the county in screen space
                const bounds = path.bounds(feature);
                const padding = 1000; // Large padding to ensure full coverage

                // Calculate line direction and perpendicular
                const dx = lineCoords[1][0] - lineCoords[0][0];
                const dy = lineCoords[1][1] - lineCoords[0][1];
                const len = Math.sqrt(dx * dx + dy * dy);
                const unitX = dx / len;
                const unitY = dy / len;
                const perpX = -unitY;
                const perpY = unitX;

                // Extend the line far beyond the county
                const extendedP1 = [
                    lineCoords[0][0] - unitX * padding,
                    lineCoords[0][1] - unitY * padding
                ];
                const extendedP2 = [
                    lineCoords[1][0] + unitX * padding,
                    lineCoords[1][1] + unitY * padding
                ];

                // Create a group that will be clipped to the county boundary
                const splitGroup = g.append('g')
                    .attr('class', 'split-county-group')
                    .attr('data-id', countyId)
                    .attr('clip-path', `url(#${clipId})`);

                // Draw side 1: a large polygon on one side of the line
                const rep1 = salesReps.find(r => r.id === assignment.rep1);
                const side1Points = [
                    extendedP1,
                    extendedP2,
                    [extendedP2[0] + perpX * padding, extendedP2[1] + perpY * padding],
                    [extendedP1[0] + perpX * padding, extendedP1[1] + perpY * padding]
                ];

                splitGroup.append('polygon')
                    .attr('class', 'split-county-half')
                    .attr('points', side1Points.map(p => p.join(',')).join(' '))
                    .attr('fill', rep1 ? rep1.color : '#d0d8e0')
                    .attr('data-id', countyId)
                    .attr('data-side', '1')
                    .on('click', () => {
                        if (!splitMode) openSplitModal(feature.properties, assignment);
                    })
                    .on('mouseover', (event) => showSplitTooltip(event, feature.properties, assignment, 1))
                    .on('mousemove', (event) => moveTooltip(event))
                    .on('mouseout', hideTooltip);

                // Draw side 2: a large polygon on the other side of the line
                const rep2 = salesReps.find(r => r.id === assignment.rep2);
                const side2Points = [
                    extendedP1,
                    extendedP2,
                    [extendedP2[0] - perpX * padding, extendedP2[1] - perpY * padding],
                    [extendedP1[0] - perpX * padding, extendedP1[1] - perpY * padding]
                ];

                splitGroup.append('polygon')
                    .attr('class', 'split-county-half')
                    .attr('points', side2Points.map(p => p.join(',')).join(' '))
                    .attr('fill', rep2 ? rep2.color : '#d0d8e0')
                    .attr('data-id', countyId)
                    .attr('data-side', '2')
                    .on('click', () => {
                        if (!splitMode) openSplitModal(feature.properties, assignment);
                    })
                    .on('mouseover', (event) => showSplitTooltip(event, feature.properties, assignment, 2))
                    .on('mousemove', (event) => moveTooltip(event))
                    .on('mouseout', hideTooltip);

                // Draw the county border on top
                splitGroup.append('path')
                    .datum(feature)
                    .attr('class', 'split-county-border')
                    .attr('d', path)
                    .attr('fill', 'none')
                    .attr('stroke', '#1a2a3a')
                    .attr('stroke-width', '1px');

                // Draw the dividing line
                g.append('line')
                    .attr('class', 'split-divider')
                    .attr('x1', lineCoords[0][0])
                    .attr('y1', lineCoords[0][1])
                    .attr('x2', lineCoords[1][0])
                    .attr('y2', lineCoords[1][1])
                    .attr('data-id', countyId);

            } catch (e) {
                console.error('Error drawing split county:', countyId, e);
                // Fall back to regular drawing
                drawRegularCounty(feature);
            }
        }

        function getCountyColor(countyId) {
            const assignment = assignments[countyId];
            if (!assignment) return '#d0d8e0';
            if (isSplitAssignment(assignment)) {
                return '#d0d8e0'; // Split counties are drawn separately
            }
            const rep = salesReps.find(r => r.id === assignment);
            return rep ? rep.color : '#d0d8e0';
        }

        function redrawMap() {
            // Clear and redraw all counties
            g.selectAll('.county').remove();
            g.selectAll('.split-county-half').remove();
            g.selectAll('.split-county-group').remove();
            g.selectAll('.split-county-border').remove();
            g.selectAll('.split-divider').remove();
            g.selectAll('.county-label').remove();
            g.selectAll('.split-point').remove();
            g.selectAll('.split-line-preview').remove();

            // Clean up clip paths
            svg.selectAll('defs clipPath[id^="clip-"]').remove();

            drawCounties();
        }

        // Zoom Controls
        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.5);
        }

        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 0.67);
        }

        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }

        // Tooltip
        function showTooltip(event, properties) {
            const tooltip = document.getElementById('tooltip');
            const countyId = properties.GEOID;
            const assignment = assignments[countyId];

            let repText = 'Unassigned';
            if (isSplitAssignment(assignment)) {
                const rep1 = salesReps.find(r => r.id === assignment.rep1);
                const rep2 = salesReps.find(r => r.id === assignment.rep2);
                repText = `Split: ${rep1 ? escapeHtml(rep1.name) : '?'} / ${rep2 ? escapeHtml(rep2.name) : '?'}`;
            } else if (assignment) {
                const rep = salesReps.find(r => r.id === assignment);
                repText = rep ? `Assigned to: ${escapeHtml(rep.name)}` : 'Unassigned';
            }

            tooltip.innerHTML = `
                <div class="tooltip-title">${escapeHtml(properties.NAME)} County</div>
                <div class="tooltip-rep">${repText}</div>
            `;
            tooltip.classList.add('visible');
            moveTooltip(event);
        }

        function showSplitTooltip(event, properties, assignment, side) {
            const tooltip = document.getElementById('tooltip');
            const repId = side === 1 ? assignment.rep1 : assignment.rep2;
            const rep = salesReps.find(r => r.id === repId);

            tooltip.innerHTML = `
                <div class="tooltip-title">${escapeHtml(properties.NAME)} County (Side ${side})</div>
                <div class="tooltip-rep">${rep ? escapeHtml(rep.name) : 'Unassigned'}</div>
            `;
            tooltip.classList.add('visible');
            moveTooltip(event);
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            const container = document.querySelector('.map-container');
            const rect = container.getBoundingClientRect();
            tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
            tooltip.style.top = (event.clientY - rect.top + 15) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // Modal
        function openModal(properties) {
            if (splitMode) return;

            selectedCounty = properties;
            document.getElementById('modalTitle').textContent = `Assign ${properties.NAME} County`;

            const select = document.getElementById('repSelect');
            select.innerHTML = '<option value="">-- Select Sales Rep --</option>';

            const currentAssignment = assignments[properties.GEOID];
            const isCurrentlySplit = isSplitAssignment(currentAssignment);

            salesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.id;
                option.textContent = rep.name;
                if (!isCurrentlySplit && currentAssignment === rep.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Show split section if county is already assigned (not split)
            const splitSection = document.getElementById('splitSection');
            if (currentAssignment && !isCurrentlySplit && salesReps.length >= 2) {
                splitSection.style.display = 'block';
            } else {
                splitSection.style.display = 'none';
            }

            document.getElementById('modalOverlay').classList.add('visible');
        }

        function openSplitModal(properties, assignment) {
            selectedCounty = properties;
            document.getElementById('modalTitle').textContent = `Manage ${properties.NAME} County (Split)`;

            const select = document.getElementById('repSelect');
            select.innerHTML = '<option value="">-- Reassign Entire County --</option>';
            salesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.id;
                option.textContent = rep.name;
                select.appendChild(option);
            });

            // Hide split section for already split counties
            document.getElementById('splitSection').style.display = 'none';

            document.getElementById('modalOverlay').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('visible');
            selectedCounty = null;
        }

        function assignCounty() {
            const repId = document.getElementById('repSelect').value;
            if (!repId || !selectedCounty) {
                closeModal();
                return;
            }

            // This overwrites any existing assignment (including splits)
            assignments[selectedCounty.GEOID] = repId;
            saveToLocalStorage();
            redrawMap();
            updateStats();
            renderRepList();
            closeModal();
        }

        function unassignCounty() {
            if (!selectedCounty) {
                closeModal();
                return;
            }

            delete assignments[selectedCounty.GEOID];
            saveToLocalStorage();
            redrawMap();
            updateStats();
            renderRepList();
            closeModal();
        }

        // Split Mode Functions
        function startSplitMode() {
            if (!selectedCounty || salesReps.length < 2) return;

            splitMode = true;
            splitCountyId = selectedCounty.GEOID;
            splitCountyFeature = ncCountiesGeoJSON.features.find(
                f => f.properties.GEOID === splitCountyId
            );
            splitPoints = [];

            closeModal();

            // Show banner
            document.getElementById('splitModeBanner').classList.add('visible');

            // Highlight target county
            g.selectAll('.county')
                .filter(function() {
                    return d3.select(this).attr('data-id') === splitCountyId;
                })
                .classed('split-target', true);

            // Disable zoom during split mode
            svg.on('.zoom', null);
        }

        function cancelSplitMode() {
            splitMode = false;
            splitCountyId = null;
            splitCountyFeature = null;
            splitPoints = [];
            splitPolygons = null;

            document.getElementById('splitModeBanner').classList.remove('visible');

            // Remove split UI elements
            g.selectAll('.split-point').remove();
            g.selectAll('.split-line-preview').remove();
            g.selectAll('.county').classed('split-target', false);

            // Re-enable zoom
            svg.call(zoom);
        }

        function handleSvgClick(event) {
            if (!splitMode || !splitCountyFeature) return;

            // Get click position in geographic coordinates
            const [mx, my] = d3.pointer(event, g.node());
            const geoCoord = projection.invert([mx, my]);

            // Check if click is inside the target county
            const point = turf.point(geoCoord);
            if (!turf.booleanPointInPolygon(point, splitCountyFeature)) {
                return; // Click outside county
            }

            splitPoints.push(geoCoord);

            // Draw point marker
            g.append('circle')
                .attr('class', 'split-point')
                .attr('cx', mx)
                .attr('cy', my)
                .attr('r', 6);

            if (splitPoints.length === 1) {
                // Update instructions
                document.querySelector('.split-mode-banner .instructions').textContent =
                    'Click second point to complete the split line';
            } else if (splitPoints.length === 2) {
                // Draw preview line
                const p1 = projection(splitPoints[0]);
                const p2 = projection(splitPoints[1]);

                g.append('line')
                    .attr('class', 'split-line-preview')
                    .attr('x1', p1[0])
                    .attr('y1', p1[1])
                    .attr('x2', p2[0])
                    .attr('y2', p2[1]);

                // With SVG clip paths, we don't need to pre-compute polygons
                // The line will be used directly to render the split visually
                // Show assignment modal
                openSplitAssignmentModal();
            }
        }

        function openSplitAssignmentModal() {
            document.getElementById('splitModalTitle').textContent =
                `Assign ${splitCountyFeature.properties.NAME} County Regions`;

            // Populate rep selects
            const select1 = document.getElementById('splitRep1');
            const select2 = document.getElementById('splitRep2');

            select1.innerHTML = '<option value="">-- Select Rep --</option>';
            select2.innerHTML = '<option value="">-- Select Rep --</option>';

            // Pre-select current rep if county was assigned
            const currentAssignment = assignments[splitCountyId];
            const currentRepId = typeof currentAssignment === 'string' ? currentAssignment : null;

            salesReps.forEach((rep, idx) => {
                const opt1 = document.createElement('option');
                opt1.value = rep.id;
                opt1.textContent = rep.name;
                if (currentRepId === rep.id) opt1.selected = true;
                select1.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = rep.id;
                opt2.textContent = rep.name;
                select2.appendChild(opt2);
            });

            document.getElementById('splitModalOverlay').classList.add('visible');
        }

        function cancelSplitAssignment() {
            document.getElementById('splitModalOverlay').classList.remove('visible');
            cancelSplitMode();
        }

        function confirmSplitAssignment() {
            const rep1Id = document.getElementById('splitRep1').value;
            const rep2Id = document.getElementById('splitRep2').value;

            if (!rep1Id || !rep2Id) {
                alert('Please select a sales rep for each side');
                return;
            }

            if (rep1Id === rep2Id) {
                alert('Please select different sales reps for each side');
                return;
            }

            // Save the split assignment
            assignments[splitCountyId] = {
                split: true,
                line: splitPoints.slice(),
                rep1: rep1Id,
                rep2: rep2Id
            };

            saveToLocalStorage();

            // Close modal and exit split mode
            document.getElementById('splitModalOverlay').classList.remove('visible');

            splitMode = false;
            splitCountyId = null;
            splitCountyFeature = null;
            splitPoints = [];
            splitPolygons = null;

            document.getElementById('splitModeBanner').classList.remove('visible');
            svg.call(zoom);

            // Redraw map
            redrawMap();
            updateStats();
            renderRepList();
        }

        // Sales Rep Management
        function addSalesRep() {
            const nameInput = document.getElementById('repName');
            const colorInput = document.getElementById('repColor');

            const name = nameInput.value.trim();
            if (!name) return;

            const rep = {
                id: 'rep_' + Date.now(),
                name: name,
                color: sanitizeColor(colorInput.value)
            };

            salesReps.push(rep);
            nameInput.value = '';
            colorInput.value = getRandomColor();

            saveToLocalStorage();
            renderRepList();
            updateStats();
            updateLegend();
        }

        function editSalesRep(repId) {
            const rep = salesReps.find(r => r.id === repId);
            if (!rep) return;

            const newName = prompt('Enter new name:', rep.name);
            if (newName && newName.trim()) {
                rep.name = newName.trim();
                saveToLocalStorage();
                renderRepList();
                updateLegend();
                redrawMap();
            }
        }

        function deleteSalesRep(repId) {
            if (!confirm('Delete this sales rep and unassign all their counties?')) return;

            // Handle regular and split assignments
            Object.keys(assignments).forEach(countyId => {
                const assignment = assignments[countyId];
                if (isSplitAssignment(assignment)) {
                    if (assignment.rep1 === repId || assignment.rep2 === repId) {
                        // If rep is part of a split, remove the entire split
                        delete assignments[countyId];
                    }
                } else if (assignment === repId) {
                    delete assignments[countyId];
                }
            });

            // Remove rep
            salesReps = salesReps.filter(r => r.id !== repId);

            saveToLocalStorage();
            renderRepList();
            redrawMap();
            updateStats();
            updateLegend();
        }

        function renderRepList() {
            const container = document.getElementById('repList');

            if (salesReps.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No sales reps added yet</p>';
                return;
            }

            container.innerHTML = salesReps.map(rep => {
                const countyCount = getRepCountyCount(rep.id);
                const safeColor = sanitizeColor(rep.color);
                const safeName = escapeHtml(rep.name);
                const safeId = escapeHtml(rep.id);
                return `
                    <div class="rep-item">
                        <div class="rep-color" style="background: ${safeColor}"></div>
                        <div class="rep-info">
                            <div class="rep-name">${safeName}</div>
                            <div class="rep-counties">${countyCount} ${countyCount === 1 ? 'county' : 'counties'}</div>
                        </div>
                        <div class="rep-actions">
                            <button class="btn btn-secondary btn-sm" data-rep-id="${safeId}" onclick="editSalesRep(this.dataset.repId)">Edit</button>
                            <button class="btn btn-danger btn-sm" data-rep-id="${safeId}" onclick="deleteSalesRep(this.dataset.repId)">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRepCountyCount(repId) {
            let count = 0;
            Object.values(assignments).forEach(assignment => {
                if (isSplitAssignment(assignment)) {
                    if (assignment.rep1 === repId) count += 0.5;
                    if (assignment.rep2 === repId) count += 0.5;
                } else if (assignment === repId) {
                    count += 1;
                }
            });
            return count;
        }

        function updateStats() {
            let assignedCount = 0;
            let splitCount = 0;

            Object.values(assignments).forEach(assignment => {
                if (isSplitAssignment(assignment)) {
                    assignedCount += 1;
                    splitCount += 1;
                } else {
                    assignedCount += 1;
                }
            });

            const totalCounties = ncCountiesGeoJSON.features.length;

            document.getElementById('totalReps').textContent = salesReps.length;
            document.getElementById('assignedCounties').textContent = assignedCount;
            document.getElementById('unassignedCounties').textContent = totalCounties - assignedCount;
            document.getElementById('totalCounties').textContent = totalCounties;
        }

        function updateLegend() {
            const container = document.getElementById('legendItems');

            let html = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #d0d8e0"></div>
                    <span>Unassigned</span>
                </div>
            `;

            salesReps.forEach(rep => {
                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${sanitizeColor(rep.color)}"></div>
                        <span>${escapeHtml(rep.name)}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getRandomColor() {
            // Meridian Waste-inspired professional color palette
            const colors = ['#f7941d', '#1a2a3a', '#2d7d46', '#c0392b', '#2980b9', '#8e44ad', '#16a085', '#d35400'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Export
        function exportMap() {
            const svgElement = document.querySelector('#map svg');
            const serializer = new XMLSerializer();

            // Clone SVG and add styles inline for export
            const svgClone = svgElement.cloneNode(true);

            // Set explicit dimensions
            svgClone.setAttribute('width', width);
            svgClone.setAttribute('height', height);

            // Add white background
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', '100%');
            bg.setAttribute('height', '100%');
            bg.setAttribute('fill', '#e8eef3');
            svgClone.insertBefore(bg, svgClone.firstChild);

            const svgString = serializer.serializeToString(svgClone);
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            // Create canvas and draw SVG
            const canvas = document.createElement('canvas');
            canvas.width = width * 2; // Higher resolution
            canvas.height = height * 2;
            const ctx = canvas.getContext('2d');
            ctx.scale(2, 2);

            const img = new Image();
            img.onerror = function() {
                alert('Failed to generate image export');
                URL.revokeObjectURL(url);
            };
            img.onload = function() {
                ctx.fillStyle = '#e8eef3';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0);

                // Download
                const link = document.createElement('a');
                link.download = 'nc-territory-map.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        // Close modal on outside click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });

        document.getElementById('splitModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'splitModalOverlay') cancelSplitAssignment();
        });

        // Enter key for adding rep
        document.getElementById('repName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addSalesRep();
        });

        // ESC key to cancel split mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && splitMode) {
                cancelSplitMode();
            }
        });
    </script>
</body>
</html>
